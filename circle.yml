general:
  artifacts:
    - $CIRCLE_TEST_REPORTS
    - coverage

machine:
  node:
    version: 6.10

dependencies:
  override:
    - cd data && npm install
    - cd build && npm install

test:
  override:
    - cd data && npm run coverage -- --reporter mocha-junit-reporter --reporter-options mochaFile=$CIRCLE_TEST_REPORTS/junit/results.xml
    - if [ -f coverage/lcov.info ] ; then cd data && CODECLIMATE_REPO_TOKEN=$CODECLIMATE_REPO_TOKEN ./node_modules/.bin/codeclimate-test-reporter < coverage/lcov.info ; fi
    - cd data && mv coverage/  $CIRCLE_TEST_REPORTS/

deployment:
  prod:
    branch: master
    commands:
      - cd ui && lein cljsbuild once min
      - cd build && npm start && cd ../
      - cd build && npm run replace && cd ../
      - sh ./bin/deploy.sh
